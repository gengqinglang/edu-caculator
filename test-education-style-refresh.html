<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ•™è‚²é£æ ¼åˆ‡æ¢æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; }
        button { margin: 5px; padding: 10px 15px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        .highlight { background: #ffeb3b; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ¯ æ•™è‚²é£æ ¼åˆ‡æ¢æ•°æ®åˆ·æ–°æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•åœºæ™¯</h3>
        <p>æ¨¡æ‹Ÿç”¨æˆ·åˆ‡æ¢æ•™è‚²é£æ ¼åæ•°æ®æ˜¯å¦æ­£ç¡®åˆ·æ–°</p>
        <button class="btn-primary" onclick="runEducationStyleTest()">å¼€å§‹æµ‹è¯•</button>
        <button class="btn-warning" onclick="clearCache()">æ¸…é™¤ç¼“å­˜</button>
    </div>
    
    <div id="testResults"></div>

    <!-- å¼•å…¥æ•°æ®æ–‡ä»¶ -->
    <script src="city-tier-mapping.js"></script>
    <script src="primary-cost-data.js"></script>
    <script src="kindergarten-primary-middle-adapter.js"></script>

    <script>
        // æ¨¡æ‹Ÿç”¨æˆ·è®¡åˆ’å¯¹è±¡
        let userPlan = {
            currentStage: 'primary',
            currentLevel: 'public', 
            currentCity: 'beijing',
            educationStyle: 'balanced'
        };
        
        // æ¨¡æ‹Ÿå…¨å±€ç¼“å­˜
        window.stageCostData = {};
        window.customCostItems = {};
        
        let adapter;
        
        // åˆå§‹åŒ–
        try {
            adapter = new KindergartenPrimaryMiddleAdapter();
        } catch (error) {
            console.error('é€‚é…å™¨åˆå§‹åŒ–å¤±è´¥:', error);
        }

        function runEducationStyleTest() {
            const resultsDiv = document.getElementById('testResults');
            let html = '';
            
            try {
                html += '<div class="result info"><h4>ğŸ§ª æµ‹è¯•æµç¨‹</h4>';
                html += '<p>1. é¦–æ¬¡è·å–"å¹³è¡¡"é£æ ¼æ•°æ®å¹¶ç¼“å­˜</p>';
                html += '<p>2. åˆ‡æ¢åˆ°"é¸¡å¨ƒ"é£æ ¼ï¼ŒéªŒè¯æ•°æ®æ˜¯å¦åˆ·æ–°</p>';
                html += '<p>3. åˆ‡æ¢å›"å¹³è¡¡"é£æ ¼ï¼ŒéªŒè¯ç¼“å­˜æ˜¯å¦ç”Ÿæ•ˆ</p>';
                html += '</div>';
                
                // æ­¥éª¤1ï¼šé¦–æ¬¡è·å–å¹³è¡¡é£æ ¼æ•°æ®
                html += '<div class="result"><h4>ğŸ“ æ­¥éª¤1ï¼šé¦–æ¬¡è·å–"å¹³è¡¡"é£æ ¼æ•°æ®</h4>';
                userPlan.educationStyle = 'balanced';
                
                const baseCostData1 = adapter.getCostData('primary', 'public', 'beijing', 'balanced');
                const mergedData1 = getMergedCostData('primary', baseCostData1);
                const calculation1 = adapter.calculateTotalCost(mergedData1, 6);
                
                // æ¨¡æ‹Ÿä¿å­˜ç¼“å­˜
                window.stageCostData['primary'] = {
                    costData: mergedData1,
                    originalCostData: JSON.parse(JSON.stringify(baseCostData1)),
                    years: 6,
                    calculation: calculation1,
                    modified: false,
                    educationStyle: userPlan.educationStyle
                };
                
                const extracurricular1 = mergedData1.costs['è¯¾å¤–è´¹'].amount;
                html += `<p>å¹³è¡¡é£æ ¼è¯¾å¤–è´¹: <span class="highlight">${extracurricular1}å…ƒ/å¹´</span></p>`;
                html += `<p>ç¼“å­˜çŠ¶æ€: ${window.stageCostData['primary'] ? 'âœ… å·²ç¼“å­˜' : 'âŒ æœªç¼“å­˜'}</p>`;
                html += `<p>ç¼“å­˜çš„æ•™è‚²é£æ ¼: ${window.stageCostData['primary']?.educationStyle}</p>`;
                html += '</div>';
                
                // æ­¥éª¤2ï¼šåˆ‡æ¢åˆ°é¸¡å¨ƒé£æ ¼
                html += '<div class="result"><h4>ğŸ”„ æ­¥éª¤2ï¼šåˆ‡æ¢åˆ°"é¸¡å¨ƒ"é£æ ¼</h4>';
                userPlan.educationStyle = 'intensive';
                
                const baseCostData2 = adapter.getCostData('primary', 'public', 'beijing', 'intensive');
                const mergedData2 = getMergedCostData('primary', baseCostData2);
                const calculation2 = adapter.calculateTotalCost(mergedData2, 6);
                
                const extracurricular2 = mergedData2.costs['è¯¾å¤–è´¹'].amount;
                html += `<p>é¸¡å¨ƒé£æ ¼è¯¾å¤–è´¹: <span class="highlight">${extracurricular2}å…ƒ/å¹´</span></p>`;
                
                const isRefreshed = extracurricular2 !== extracurricular1;
                html += `<p>æ•°æ®åˆ·æ–°çŠ¶æ€: ${isRefreshed ? 'âœ… å·²åˆ·æ–°' : 'âŒ æœªåˆ·æ–°'}</p>`;
                
                if (isRefreshed) {
                    html += `<p class="success">âœ… æ•™è‚²é£æ ¼åˆ‡æ¢åæ•°æ®æ­£ç¡®åˆ·æ–°ï¼</p>`;
                } else {
                    html += `<p class="warning">âš ï¸ æ•™è‚²é£æ ¼åˆ‡æ¢åæ•°æ®æœªåˆ·æ–°ï¼Œå¯èƒ½å­˜åœ¨ç¼“å­˜é—®é¢˜</p>`;
                }
                html += '</div>';
                
                // æ­¥éª¤3ï¼šåˆ‡æ¢å›å¹³è¡¡é£æ ¼ï¼Œæµ‹è¯•ç¼“å­˜
                html += '<div class="result"><h4>ğŸ’¾ æ­¥éª¤3ï¼šåˆ‡æ¢å›"å¹³è¡¡"é£æ ¼ï¼Œæµ‹è¯•ç¼“å­˜</h4>';
                
                // æ¸…é™¤å½“å‰ç¼“å­˜ï¼Œé‡æ–°è®¾ç½®å¹³è¡¡é£æ ¼ç¼“å­˜
                window.stageCostData['primary'] = {
                    costData: mergedData1,
                    originalCostData: JSON.parse(JSON.stringify(baseCostData1)),
                    years: 6,
                    calculation: calculation1,
                    modified: false,
                    educationStyle: 'balanced'  // å¹³è¡¡é£æ ¼ç¼“å­˜
                };
                
                userPlan.educationStyle = 'balanced';
                
                const baseCostData3 = adapter.getCostData('primary', 'public', 'beijing', 'balanced');
                const mergedData3 = getMergedCostData('primary', baseCostData3);
                
                const extracurricular3 = mergedData3.costs['è¯¾å¤–è´¹'].amount;
                html += `<p>é‡æ–°è·å–å¹³è¡¡é£æ ¼è¯¾å¤–è´¹: <span class="highlight">${extracurricular3}å…ƒ/å¹´</span></p>`;
                
                const cacheWorking = extracurricular3 === extracurricular1;
                html += `<p>ç¼“å­˜æœºåˆ¶çŠ¶æ€: ${cacheWorking ? 'âœ… æ­£å¸¸å·¥ä½œ' : 'âŒ å¼‚å¸¸'}</p>`;
                html += '</div>';
                
                // æ±‡æ€»æµ‹è¯•ç»“æœ
                html += '<div class="result"><h4>ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»</h4>';
                html += '<table>';
                html += '<tr><th>æ•™è‚²é£æ ¼</th><th>è¯¾å¤–è´¹(å…ƒ/å¹´)</th><th>æ•°æ®æ¥æº</th></tr>';
                html += `<tr><td>å¹³è¡¡(é¦–æ¬¡)</td><td>${extracurricular1}</td><td>æ–°æ•°æ®</td></tr>`;
                html += `<tr><td>é¸¡å¨ƒ</td><td>${extracurricular2}</td><td>${isRefreshed ? 'æ–°æ•°æ®' : 'ç¼“å­˜'}</td></tr>`;
                html += `<tr><td>å¹³è¡¡(å†æ¬¡)</td><td>${extracurricular3}</td><td>${cacheWorking ? 'ç¼“å­˜' : 'æ–°æ•°æ®'}</td></tr>`;
                html += '</table>';
                
                const overallSuccess = isRefreshed && cacheWorking;
                if (overallSuccess) {
                    html += '<p class="success"><strong>ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ•™è‚²é£æ ¼åˆ‡æ¢å’Œç¼“å­˜æœºåˆ¶éƒ½æ­£å¸¸å·¥ä½œã€‚</strong></p>';
                } else {
                    html += '<p class="warning"><strong>âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥ç¼“å­˜é€»è¾‘ã€‚</strong></p>';
                }
                html += '</div>';
                
            } catch (error) {
                html += `<div class="result warning">`;
                html += `<h4>âŒ æµ‹è¯•å¤±è´¥</h4>`;
                html += `<p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>`;
                html += `<p>é”™è¯¯å †æ ˆ: <pre>${error.stack}</pre></p>`;
                html += `</div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function clearCache() {
            window.stageCostData = {};
            window.customCostItems = {};
            document.getElementById('testResults').innerHTML = '<div class="result info"><p>âœ… ç¼“å­˜å·²æ¸…é™¤</p></div>';
        }
        
        // æ¨¡æ‹ŸgetMergedCostDataå‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function getMergedCostData(stageCode, baseCostData) {
            console.log('åˆå¹¶è´¹ç”¨æ•°æ® - stageCode:', stageCode);
            console.log('å½“å‰æ•™è‚²é£æ ¼:', userPlan.educationStyle);
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ç¼“å­˜æ•°æ®
            let mergedCostData;
            const cachedData = window.stageCostData && window.stageCostData[stageCode];
            
            if (cachedData && cachedData.costData) {
                // æ£€æŸ¥ç¼“å­˜çš„æ•™è‚²é£æ ¼æ˜¯å¦ä¸å½“å‰é€‰æ‹©ä¸€è‡´
                const cachedEducationStyle = cachedData.educationStyle;
                const currentEducationStyle = userPlan.educationStyle;
                
                console.log('ç¼“å­˜çš„æ•™è‚²é£æ ¼:', cachedEducationStyle);
                console.log('å½“å‰çš„æ•™è‚²é£æ ¼:', currentEducationStyle);
                
                if (cachedEducationStyle === currentEducationStyle) {
                    // æ•™è‚²é£æ ¼æœªå˜ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®
                    console.log('âœ… æ•™è‚²é£æ ¼æœªå˜ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®');
                    mergedCostData = JSON.parse(JSON.stringify(cachedData.costData));
                } else {
                    // æ•™è‚²é£æ ¼å·²å˜ï¼Œå¼ºåˆ¶ä½¿ç”¨æ–°æ•°æ®
                    console.log('ğŸ”„ æ•™è‚²é£æ ¼å·²å˜ï¼Œå¼ºåˆ¶åˆ·æ–°æ•°æ®');
                    mergedCostData = JSON.parse(JSON.stringify(baseCostData));
                }
            } else {
                // æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œä½¿ç”¨åŸå§‹åŸºç¡€æ•°æ®
                console.log('ğŸ“ æ²¡æœ‰ç¼“å­˜æ•°æ®ï¼Œä½¿ç”¨åŸå§‹åŸºç¡€æ•°æ®');
                mergedCostData = JSON.parse(JSON.stringify(baseCostData));
            }
            
            return mergedCostData;
        }
    </script>
</body>
</html>
