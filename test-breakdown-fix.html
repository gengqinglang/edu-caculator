<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Breakdownå­—æ®µä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .code { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Breakdownå­—æ®µä¿®å¤æµ‹è¯•</h1>
    
    <button onclick="testBreakdownStructure()">æµ‹è¯•Breakdownç»“æ„</button>
    
    <div id="testResults"></div>

    <!-- å¼•å…¥æ•°æ®æ–‡ä»¶ -->
    <script src="city-tier-mapping.js"></script>
    <script src="primary-cost-data.js"></script>
    <script src="kindergarten-primary-middle-adapter.js"></script>

    <script>
        function testBreakdownStructure() {
            const resultsDiv = document.getElementById('testResults');
            let html = '';
            
            try {
                // åˆå§‹åŒ–é€‚é…å™¨
                const adapter = new KindergartenPrimaryMiddleAdapter();
                
                // æµ‹è¯•æ•°æ®è·å–
                const costData = adapter.getCostData('primary', 'public', 'beijing', 'balanced');
                const calculation = adapter.calculateTotalCost(costData, 6);
                
                console.log('å®Œæ•´è®¡ç®—ç»“æœ:', calculation);
                
                // 1. æ£€æŸ¥breakdownå­—æ®µæ˜¯å¦å­˜åœ¨
                html += '<div class="test-result ' + (calculation.breakdown ? 'success' : 'error') + '">';
                html += '<h3>1. Breakdownå­—æ®µæ£€æŸ¥</h3>';
                if (calculation.breakdown) {
                    html += '<p>âœ… calculation.breakdown å­˜åœ¨</p>';
                    html += `<p>åŒ…å«è´¹ç”¨é¡¹æ•°é‡: ${Object.keys(calculation.breakdown).length}</p>`;
                } else {
                    html += '<p>âŒ calculation.breakdown ä¸å­˜åœ¨</p>';
                }
                html += '</div>';
                
                // 2. æ£€æŸ¥breakdownç»“æ„å®Œæ•´æ€§
                if (calculation.breakdown) {
                    html += '<div class="test-result info">';
                    html += '<h3>2. Breakdownç»“æ„è¯¦æƒ…</h3>';
                    html += '<table>';
                    html += '<tr><th>è´¹ç”¨é¡¹</th><th>åŸå§‹é‡‘é¢</th><th>è´§å¸</th><th>æ€»è´¹ç”¨</th><th>å¹´å‡è´¹ç”¨</th><th>æ˜¯å¦ä¸€æ¬¡æ€§</th></tr>';
                    
                    let allFieldsPresent = true;
                    Object.entries(calculation.breakdown).forEach(([key, breakdown]) => {
                        const requiredFields = ['originalAmount', 'originalCurrency', 'convertedAmount', 'exchangeRate', 'totalForPeriod', 'yearlyAmount', 'unit', 'isOnceOnly', 'schoolCount'];
                        const missingFields = requiredFields.filter(field => breakdown[field] === undefined);
                        
                        if (missingFields.length > 0) {
                            allFieldsPresent = false;
                        }
                        
                        html += `<tr>
                            <td>${key}</td>
                            <td>${breakdown.originalAmount}</td>
                            <td>${breakdown.originalCurrency}</td>
                            <td>${breakdown.totalForPeriod}</td>
                            <td>${breakdown.yearlyAmount}</td>
                            <td>${breakdown.isOnceOnly ? 'æ˜¯' : 'å¦'}</td>
                        </tr>`;
                    });
                    html += '</table>';
                    
                    html += `<p><strong>å­—æ®µå®Œæ•´æ€§: ${allFieldsPresent ? 'âœ… å®Œæ•´' : 'âŒ ä¸å®Œæ•´'}</strong></p>`;
                    html += '</div>';
                }
                
                // 3. æ¨¡æ‹ŸåŸç³»ç»Ÿè°ƒç”¨
                html += '<div class="test-result">';
                html += '<h3>3. åŸç³»ç»Ÿè°ƒç”¨æ¨¡æ‹Ÿ</h3>';
                
                try {
                    // æ¨¡æ‹ŸdisplayCostDetailsä¸­çš„è°ƒç”¨
                    const testKey = 'å­¦è´¹';
                    if (calculation.breakdown[testKey]) {
                        const calcCost = calculation.breakdown[testKey];
                        const totalForPeriod = calcCost.totalForPeriod;
                        
                        html += '<div class="success">';
                        html += '<div class="code">';
                        html += `// åŸç³»ç»Ÿè°ƒç”¨ï¼š<br>`;
                        html += `calculation.breakdown['${testKey}'].totalForPeriod<br>`;
                        html += `// ç»“æœ: ${totalForPeriod}`;
                        html += '</div>';
                        html += '<p>âœ… åŸç³»ç»Ÿè°ƒç”¨æˆåŠŸ</p>';
                        html += '</div>';
                    } else {
                        html += '<div class="error">';
                        html += `<p>âŒ æœªæ‰¾åˆ° '${testKey}' çš„breakdownæ•°æ®</p>`;
                        html += '</div>';
                    }
                } catch (error) {
                    html += '<div class="error">';
                    html += `<p>âŒ åŸç³»ç»Ÿè°ƒç”¨å¤±è´¥: ${error.message}</p>`;
                    html += '</div>';
                }
                html += '</div>';
                
                // 4. å¯¹æ¯”æ–°æ—§ç»“æ„
                html += '<div class="test-result info">';
                html += '<h3>4. æ–°æ—§ç»“æ„å¯¹æ¯”</h3>';
                html += '<div class="code">';
                html += 'æ–°ç»“æ„ (details):<br>';
                if (calculation.details && calculation.details['å­¦è´¹']) {
                    html += `details['å­¦è´¹'].itemTotal = ${calculation.details['å­¦è´¹'].itemTotal}<br>`;
                }
                html += '<br>æ—§ç»“æ„ (breakdown):<br>';
                if (calculation.breakdown && calculation.breakdown['å­¦è´¹']) {
                    html += `breakdown['å­¦è´¹'].totalForPeriod = ${calculation.breakdown['å­¦è´¹'].totalForPeriod}<br>`;
                }
                html += '</div>';
                
                // æ£€æŸ¥æ•°å€¼æ˜¯å¦ä¸€è‡´
                if (calculation.details && calculation.breakdown && 
                    calculation.details['å­¦è´¹'] && calculation.breakdown['å­¦è´¹']) {
                    const detailsValue = calculation.details['å­¦è´¹'].itemTotal;
                    const breakdownValue = calculation.breakdown['å­¦è´¹'].totalForPeriod;
                    const isConsistent = detailsValue === breakdownValue;
                    
                    html += `<p>æ•°å€¼ä¸€è‡´æ€§: ${isConsistent ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'} (${detailsValue} vs ${breakdownValue})</p>`;
                }
                html += '</div>';
                
                // 5. æµ‹è¯•metadataå­—æ®µ
                html += '<div class="test-result ' + (calculation.metadata ? 'success' : 'error') + '">';
                html += '<h3>5. Metadataå­—æ®µæ£€æŸ¥</h3>';
                if (calculation.metadata) {
                    html += '<p>âœ… calculation.metadata å­˜åœ¨</p>';
                    html += `<p>è®¡ç®—å¹´æ•°: ${calculation.metadata.years}</p>`;
                    html += `<p>æ±‡ç‡: ${JSON.stringify(calculation.metadata.exchangeRates)}</p>`;
                    html += `<p>è®¡ç®—æ—¶é—´: ${calculation.metadata.calculationDate}</p>`;
                } else {
                    html += '<p>âŒ calculation.metadata ä¸å­˜åœ¨</p>';
                }
                html += '</div>';
                
            } catch (error) {
                html += '<div class="test-result error">';
                html += '<h3>âŒ æµ‹è¯•å¤±è´¥</h3>';
                html += `<p>é”™è¯¯ä¿¡æ¯: ${error.message}</p>`;
                html += `<p>é”™è¯¯å †æ ˆ: <pre>${error.stack}</pre></p>`;
                html += '</div>';
            }
            
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
